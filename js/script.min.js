let gameover, mistakes, start_time, timer, drawing
function reset() {
    gameover = false
    mistakes = 0
    mistakes_label.innerText = mistakes
    mistakes_label.classList.remove('notzero')
    win_label.classList.remove('active')
    document.querySelector('game').className = ''
    document.querySelectorAll('game>*').forEach(e => e.remove())
    let size = parseInt(size_slider.value)
    let data = new Array(size).fill(new Array(size).fill(0)).map(r => r.map(c => Math.random() < chance_slider.value / 100))
    let table = document.createElement('table')
    let first_row = document.createElement('tr')
    first_row.append(document.createElement('td'))
    for (let x = 0; x < size; x++) {
        let f = document.createElement('td')
        f.innerHTML = [...data].reduce((a, b) => [...a, ...b], [])
            .filter((e, i) => i % size === x)
            .reduce((a, b) => b ? a + '1' : a + '0', '')
            .split('0').map(f => f.length).filter(f => f != 0).join('<br>')
        first_row.append(f)
    }
    table.append(first_row)
    let division = size < 6 ? null : size == 6 ? 3 : [7, 8].includes(size) ? 4 : 5
    for (let y = 0; y < size; y++) {
        let tr = document.createElement('tr')
        tr.append(document.createElement('td'))
        for (let x = 0; x < size; x++) {
            let f = document.createElement('td')
            f.setAttribute('y', y)
            f.setAttribute('x', x)
            f.setAttribute('complete', false)
            f.setAttribute('clicked', false)
            f.setAttribute('legit', data[y][x])
            f.addEventListener('contextmenu', e => {
                e.preventDefault()
            })
            f.addEventListener('mouseenter', e => {
                if (drawing !== false && [0, 1].includes(drawing)) open_field(f, drawing)
            })
            f.addEventListener('mousedown', e => {
                if ([0, 2].includes(e.button)) {
                    drawing = e.button == 0 ? 0 : 1
                    open_field(e.target, drawing)
                }
            })
            f.className = 'field'
            if (division) {
                if (x % division == division - 1) f.classList.add('divider', 'r')
                else if (x % division == 0) f.classList.add('divider', 'l')

                if (y % division == division - 1) f.classList.add('divider', 'b')
                else if (y % division == 0) f.classList.add('divider', 't')
            }
            tr.append(f)
        }
        table.append(tr)
    }
    document.querySelector('game').append(table)
    document.querySelectorAll('tr:not(:first-of-type) td:first-of-type').forEach((f, y) => {
        f.innerHTML = data[y]
            .reduce((a, b) => b ? a + '1' : a + '0', '')
            .split('0').map(f => f.length).filter(f => f != 0).join(' ')
    })
    table.style.paddingRight = `${document.querySelector('td').offsetWidth / 2}px`
    if (timer) clearInterval(timer)
    start_time = new Date().getTime()
    timer = setInterval(() => {
        let t = new Date().getTime() - start_time
        let h = Math.floor(t / 3600000)
        h = h.toString().length == 1 ? '0' + h : h
        t -= h * 3600000
        let m = Math.floor(t / 60000)
        m = m.toString().length == 1 ? '0' + m : m
        t -= m * 60000
        let s = Math.floor(t / 1000)
        s = s.toString().length == 1 ? '0' + s : s
        t -= s * 1000
        timer_label.innerText = `${h}:${m}:${s}`
    }, 100)
}
function open_field(f, n) {
    if (!gameover && !f.classList.contains('fail') && f.getAttribute('clicked') == 'false' && f.getAttribute('complete') == 'false') {
        if (n == 0 && f.getAttribute('legit') == 'true' || n == 1 && f.getAttribute('legit') == 'false') {
            f.setAttribute('clicked', 'true')
            if (n == 0) f.classList.add('legit')
            if (document.querySelectorAll(`td.field[legit = 'true'][clicked = 'false']`).length == 0) {
                clearInterval(timer)
                document.querySelectorAll(`field`).forEach(e => {
                    if (e.getAttribute('complete') == 'false' && e.getAttribute('clicked') == false) e.style.animationDelay = `${Math.random().toFixed(2)}s`
                    else e.style.animationDelay = null
                })
                document.querySelector('game').classList.add('gameover')
                gameover = true
                win_label.classList.add('active')
            } else {
                if (document.querySelectorAll(`td.field[y='${f.getAttribute('y')}'][legit='true'][clicked='false']`).length == 0) {
                    let row = document.querySelectorAll(`td.field[y='${f.getAttribute('y')}']`)
                    row.forEach((e, x) => {
                        e.setAttribute('complete', 'false')
                        e.style.animationDelay = `${x / (row.length - 1)}s`
                        e.setAttribute('complete', 'true')
                    })
                }
                if (document.querySelectorAll(`td.field[x='${f.getAttribute('x')}'][legit='true'][clicked='false']`).length == 0) {
                    let col = document.querySelectorAll(`td.field[x='${f.getAttribute('x')}']`)
                    col.forEach((e, y) => {
                        e.setAttribute('complete', 'false')
                        e.style.animationDelay = `${y / (col.length - 1)}s`
                        e.setAttribute('complete', 'true')
                    })
                }
            }
        } else {
            mistakes_label.innerText = ++mistakes
            mistakes_label.classList.add('notzero')
            f.classList.add('fail')
            setTimeout(() => f.classList.remove('fail'), 1000)
        }
    }
}
let timer_label = document.querySelector('#time_label span')
let chance_slider = document.querySelector('#chance_slider')
chance_slider.addEventListener('input', e => chance_label.innerText = `Chance: ${chance_slider.value}% `)
let size_slider = document.querySelector('#size_slider')
size_slider.addEventListener('input', e => size_label.innerText = `Size: ${size_slider.value}x${size_slider.value} `)
let chance_label = document.querySelector('#chance_label')
chance_label.innerText = `Chance: ${chance_slider.value}% `
let size_label = document.querySelector('#size_label')
size_label.innerText = `Size: ${size_slider.value}x${size_slider.value} `
let mistakes_label = document.querySelector('#mistakes_label span')
let win_label = document.querySelector('#win_label')
window.onmouseup = () => drawing = null
document.querySelector('#reset_btn').addEventListener('click', reset)
reset()